@IsTest public with sharing class WebhookTriggerHandlerTest {
    @isTest(SeeAllData=false)
    public static void testMethod1(){
        test.startTest();
        date myDateOld = date.newInstance(2021, 01, 21);
        date myDateNew = myDateOld.addMonths(3);
        
        Account objAccount = new Account();
        objAccount.name='Test Account';
        objAccount.Stripe_Customer_Id__c='cus_KukVDA20zR89EE';
        insert objAccount;
        
        Subscription__c sub1 = new Subscription__c();
        sub1.isActive__c = true;
        sub1.Start_Date__c = myDateOld;
        sub1.End_Date__c =  myDateNew;
        sub1.Account__c = objAccount.id;
        sub1.Stripe_Sub_Scheduled_Id__c = 'sub_1KG94zSJhC5U83eHSbcK8WAt';
        Insert sub1;
        
        Webhook__c hook = new Webhook__c();
        hook.Body__c = '{"id":"evt_1KG95XSJhC5U83eHsimd6hwr","object":"event","api_version":"2020-08-27","created":1641764285,"data":{"object":{"id":"in_1KG94zSJhC5U83eHIknXBl19","object":"invoice","account_country":"IN","account_name":null,"account_tax_ids":null,"amount_due":108216,"amount_paid":108216,"amount_remaining":0,"application_fee_amount":null,"attempt_count":1,"attempted":true,"auto_advance":false,"automatic_tax":{"enabled":false,"status":null},"billing_reason":"subscription_create","charge":"ch_3KG95TSJhC5U83eH0ky3YPn9","collection_method":"charge_automatically","created":1641764253,"currency":"inr","custom_fields":null,"customer":"cus_KukVDA20zR89EE","customer_address":null,"customer_email":"sanjeet.mahajan@gmail.com","customer_name":"Sanjeet Mahajan","customer_phone":null,"customer_shipping":null,"customer_tax_exempt":"none","customer_tax_ids":[],"default_payment_method":null,"default_source":null,"default_tax_rates":[],"description":null,"discount":null,"discounts":[],"due_date":null,"ending_balance":0,"footer":null,"hosted_invoice_url":"https://invoice.stripe.com/i/acct_1IgbcsSJhC5U83eH/test_YWNjdF8xSWdiY3NTSmhDNVU4M2VILF9LdzE3dHp2SDdJSENOR25wa0dVNld1UGpIT0FsSjRZ0100qI4OPJlL","invoice_pdf":"https://pay.stripe.com/invoice/acct_1IgbcsSJhC5U83eH/test_YWNjdF8xSWdiY3NTSmhDNVU4M2VILF9LdzE3dHp2SDdJSENOR25wa0dVNld1UGpIT0FsSjRZ0100qI4OPJlL/pdf","last_finalization_error":null,"lines":{"object":"list","data":[{"id":"il_1KG94zSJhC5U83eHpxGY0mgB","object":"line_item","amount":8216,"currency":"inr","description":"Time on sunglasses from 07 Jan 2022 until 09 Jan 2022","discount_amounts":[],"discountable":false,"discounts":[],"invoice_item":"ii_1KG94zSJhC5U83eHYEC03VE3","livemode":false,"metadata":{},"period":{"end":1641764253,"start":1641544200},"plan":{"id":"price_1K49VFSJhC5U83eHqpAyXF3z","object":"plan","active":true,"aggregate_usage":null,"amount":100000,"amount_decimal":"100000","billing_scheme":"per_unit","created":1638905945,"currency":"inr","interval":"month","interval_count":1,"livemode":false,"metadata":{},"nickname":null,"product":"prod_KjckEIPJvVxUcJ","tiers_mode":null,"transform_usage":null,"trial_period_days":null,"usage_type":"licensed"},"price":{"id":"price_1K49VFSJhC5U83eHqpAyXF3z","object":"price","active":true,"billing_scheme":"per_unit","created":1638905945,"currency":"inr","livemode":false,"lookup_key":null,"metadata":{},"nickname":null,"product":"prod_KjckEIPJvVxUcJ","recurring":{"aggregate_usage":null,"interval":"month","interval_count":1,"trial_period_days":null,"usage_type":"licensed"},"tax_behavior":"unspecified","tiers_mode":null,"transform_quantity":null,"type":"recurring","unit_amount":100000,"unit_amount_decimal":"100000"},"proration":true,"quantity":1,"subscription":"sub_1KG94zSJhC5U83eHSbcK8WAt","subscription_item":"si_Kw17LCPk1tTtxJ","tax_amounts":[],"tax_rates":[],"type":"invoiceitem"},{"id":"il_1KG94zSJhC5U83eHMFbobaQV","object":"line_item","amount":100000,"currency":"inr","description":"1 × sunglasses (at ₹1,000.00 / month)","discount_amounts":[],"discountable":true,"discounts":[],"livemode":false,"metadata":{},"period":{"end":1644442653,"start":1641764253},"plan":{"id":"price_1K49VFSJhC5U83eHqpAyXF3z","object":"plan","active":true,"aggregate_usage":null,"amount":100000,"amount_decimal":"100000","billing_scheme":"per_unit","created":1638905945,"currency":"inr","interval":"month","interval_count":1,"livemode":false,"metadata":{},"nickname":null,"product":"prod_KjckEIPJvVxUcJ","tiers_mode":null,"transform_usage":null,"trial_period_days":null,"usage_type":"licensed"},"price":{"id":"price_1K49VFSJhC5U83eHqpAyXF3z","object":"price","active":true,"billing_scheme":"per_unit","created":1638905945,"currency":"inr","livemode":false,"lookup_key":null,"metadata":{},"nickname":null,"product":"prod_KjckEIPJvVxUcJ","recurring":{"aggregate_usage":null,"interval":"month","interval_count":1,"trial_period_days":null,"usage_type":"licensed"},"tax_behavior":"unspecified","tiers_mode":null,"transform_quantity":null,"type":"recurring","unit_amount":100000,"unit_amount_decimal":"100000"},"proration":false,"quantity":1,"subscription":"sub_1KG94zSJhC5U83eHSbcK8WAt","subscription_item":"si_Kw17LCPk1tTtxJ","tax_amounts":[],"tax_rates":[],"type":"subscription"}],"has_more":false,"total_count":2,"url":"/v1/invoices/in_1KG94zSJhC5U83eHIknXBl19/lines"},"livemode":false,"metadata":{},"next_payment_attempt":null,"number":"B3F69A01-0016","on_behalf_of":null,"paid":true,"payment_intent":"pi_3KG95TSJhC5U83eH09NEBIf2","payment_settings":{"payment_method_options":null,"payment_method_types":null},"period_end":1641764253,"period_start":1641764253,"post_payment_credit_notes_amount":0,"pre_payment_credit_notes_amount":0,"quote":null,"receipt_number":null,"starting_balance":0,"statement_descriptor":null,"status":"paid","status_transitions":{"finalized_at":1641764283,"marked_uncollectible_at":null,"paid_at":1641764283,"voided_at":null},"subscription":"sub_1KG94zSJhC5U83eHSbcK8WAt","subtotal":108216,"tax":null,"total":108216,"total_discount_amounts":[],"total_tax_amounts":[],"transfer_data":null,"webhooks_delivered_at":1641764257}},"livemode":false,"pending_webhooks":3,"request":{"id":"req_ip3WaBupjqd02H","idempotency_key":"a999c986-318f-4aab-872e-483b33fc3b0e"},"type":"invoice.payment_succeeded"}';
        insert hook;
        system.assertEquals(1,[SELECT ID,Paid__c FROM Invoice__c].size());
        system.assertEquals(1,[SELECT ID FROM Payment__c].size());
        test.stopTest();
    }
    @isTest(SeeAllData=false)
    public static void testMethod2(){
        test.startTest();
        date myDateOld = date.newInstance(2021, 01, 21);
        date myDateNew = myDateOld.addMonths(3);
        
        Account objAccount = new Account();
        objAccount.name='Test Account';
        objAccount.Stripe_Customer_Id__c='cus_KukVDA20zR89EE';
        insert objAccount;
        
        Subscription__c sub1 = new Subscription__c();
        sub1.isActive__c = true;
        sub1.Start_Date__c = myDateOld;
        sub1.End_Date__c =  myDateNew;
        sub1.Account__c = objAccount.id;
        sub1.Stripe_Sub_Scheduled_Id__c = 'sub_1KG94zSJhC5U83eHSbcK8WAt';
        Insert sub1;
        
        Webhook__c hook = new Webhook__c();
        hook.Body__c = '{"id":"evt_1KG95XSJhC5U83eHsimd6hwr","object":"event","api_version":"2020-08-27","created":1641764285,"data":{"object":{"id":"in_1KG94zSJhC5U83eHIknXBl19","object":"invoice","account_country":"IN","account_name":null,"account_tax_ids":null,"amount_due":108216,"amount_paid":108216,"amount_remaining":0,"application_fee_amount":null,"attempt_count":1,"attempted":true,"auto_advance":false,"automatic_tax":{"enabled":false,"status":null},"billing_reason":"subscription_create","charge":"ch_3KG95TSJhC5U83eH0ky3YPn9","collection_method":"charge_automatically","created":1641764253,"currency":"inr","custom_fields":null,"customer":"cus_KukVDA20zR89EE","customer_address":null,"customer_email":"sanjeet.mahajan@gmail.com","customer_name":"Sanjeet Mahajan","customer_phone":null,"customer_shipping":null,"customer_tax_exempt":"none","customer_tax_ids":[],"default_payment_method":null,"default_source":null,"default_tax_rates":[],"description":null,"discount":null,"discounts":[],"due_date":null,"ending_balance":0,"footer":null,"hosted_invoice_url":"https://invoice.stripe.com/i/acct_1IgbcsSJhC5U83eH/test_YWNjdF8xSWdiY3NTSmhDNVU4M2VILF9LdzE3dHp2SDdJSENOR25wa0dVNld1UGpIT0FsSjRZ0100qI4OPJlL","invoice_pdf":"https://pay.stripe.com/invoice/acct_1IgbcsSJhC5U83eH/test_YWNjdF8xSWdiY3NTSmhDNVU4M2VILF9LdzE3dHp2SDdJSENOR25wa0dVNld1UGpIT0FsSjRZ0100qI4OPJlL/pdf","last_finalization_error":null,"lines":{"object":"list","data":[{"id":"il_1KG94zSJhC5U83eHpxGY0mgB","object":"line_item","amount":8216,"currency":"inr","description":"Time on sunglasses from 07 Jan 2022 until 09 Jan 2022","discount_amounts":[],"discountable":false,"discounts":[],"invoice_item":"ii_1KG94zSJhC5U83eHYEC03VE3","livemode":false,"metadata":{},"period":{"end":1641764253,"start":1641544200},"plan":{"id":"price_1K49VFSJhC5U83eHqpAyXF3z","object":"plan","active":true,"aggregate_usage":null,"amount":100000,"amount_decimal":"100000","billing_scheme":"per_unit","created":1638905945,"currency":"inr","interval":"month","interval_count":1,"livemode":false,"metadata":{},"nickname":null,"product":"prod_KjckEIPJvVxUcJ","tiers_mode":null,"transform_usage":null,"trial_period_days":null,"usage_type":"licensed"},"price":{"id":"price_1K49VFSJhC5U83eHqpAyXF3z","object":"price","active":true,"billing_scheme":"per_unit","created":1638905945,"currency":"inr","livemode":false,"lookup_key":null,"metadata":{},"nickname":null,"product":"prod_KjckEIPJvVxUcJ","recurring":{"aggregate_usage":null,"interval":"month","interval_count":1,"trial_period_days":null,"usage_type":"licensed"},"tax_behavior":"unspecified","tiers_mode":null,"transform_quantity":null,"type":"recurring","unit_amount":100000,"unit_amount_decimal":"100000"},"proration":true,"quantity":1,"subscription":"sub_1KG94zSJhC5U83eHSbcK8WAt","subscription_item":"si_Kw17LCPk1tTtxJ","tax_amounts":[],"tax_rates":[],"type":"invoiceitem"},{"id":"il_1KG94zSJhC5U83eHMFbobaQV","object":"line_item","amount":100000,"currency":"inr","description":"1 × sunglasses (at ₹1,000.00 / month)","discount_amounts":[],"discountable":true,"discounts":[],"livemode":false,"metadata":{},"period":{"end":1644442653,"start":1641764253},"plan":{"id":"price_1K49VFSJhC5U83eHqpAyXF3z","object":"plan","active":true,"aggregate_usage":null,"amount":100000,"amount_decimal":"100000","billing_scheme":"per_unit","created":1638905945,"currency":"inr","interval":"month","interval_count":1,"livemode":false,"metadata":{},"nickname":null,"product":"prod_KjckEIPJvVxUcJ","tiers_mode":null,"transform_usage":null,"trial_period_days":null,"usage_type":"licensed"},"price":{"id":"price_1K49VFSJhC5U83eHqpAyXF3z","object":"price","active":true,"billing_scheme":"per_unit","created":1638905945,"currency":"inr","livemode":false,"lookup_key":null,"metadata":{},"nickname":null,"product":"prod_KjckEIPJvVxUcJ","recurring":{"aggregate_usage":null,"interval":"month","interval_count":1,"trial_period_days":null,"usage_type":"licensed"},"tax_behavior":"unspecified","tiers_mode":null,"transform_quantity":null,"type":"recurring","unit_amount":100000,"unit_amount_decimal":"100000"},"proration":false,"quantity":1,"subscription":"sub_1KG94zSJhC5U83eHSbcK8WAt","subscription_item":"si_Kw17LCPk1tTtxJ","tax_amounts":[],"tax_rates":[],"type":"subscription"}],"has_more":false,"total_count":2,"url":"/v1/invoices/in_1KG94zSJhC5U83eHIknXBl19/lines"},"livemode":false,"metadata":{},"next_payment_attempt":null,"number":"B3F69A01-0016","on_behalf_of":null,"paid":true,"payment_intent":"pi_3KG95TSJhC5U83eH09NEBIf2","payment_settings":{"payment_method_options":null,"payment_method_types":null},"period_end":1641764253,"period_start":1641764253,"post_payment_credit_notes_amount":0,"pre_payment_credit_notes_amount":0,"quote":null,"receipt_number":null,"starting_balance":0,"statement_descriptor":null,"status":"paid","status_transitions":{"finalized_at":1641764283,"marked_uncollectible_at":null,"paid_at":1641764283,"voided_at":null},"subscription":"sub_1KG94zSJhC5U83eHSbcK8WAt","subtotal":108216,"tax":null,"total":108216,"total_discount_amounts":[],"total_tax_amounts":[],"transfer_data":null,"webhooks_delivered_at":1641764257}},"livemode":false,"pending_webhooks":3,"request":{"id":"req_ip3WaBupjqd02H","idempotency_key":"a999c986-318f-4aab-872e-483b33fc3b0e"},"type":"invoice.payment_failed"}';
        insert hook;
        system.assertEquals(1,[SELECT ID,Paid__c FROM Invoice__c].size());
        system.assertEquals(0,[SELECT ID FROM Payment__c].size());
        test.stopTest();
    }
}